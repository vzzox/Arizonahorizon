<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MEMASIK 2.0 | FEED</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Unbounded:wght@500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           1. CORE & VARIABLES
           ========================================= */
        :root {
            --bg-body: #0a0a0c;
            --bg-card: #141416;
            --bg-nav: rgba(15, 15, 17, 0.94);
            --text-main: #ffffff;
            --text-muted: #888890;
            --accent: #ff5e00;
            --accent-dim: rgba(255, 94, 0, 0.15);
            --danger: #ff3333;
            --success: #00ff88;
            --border: #2a2a2e;
            --radius-L: 20px;
            --radius-S: 12px;
            --header-h: 60px;
            --nav-h: 75px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-body); color: var(--text-main);
            font-family: 'Manrope', sans-serif; height: 100vh;
            overflow-y: auto; overflow-x: hidden;
            padding-top: var(--header-h); padding-bottom: calc(var(--nav-h) + 20px);
            -webkit-overflow-scrolling: touch;
        }

        /* Noise Texture & Glow */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            opacity: 0.6; pointer-events: none; z-index: -1;
        }

        ::-webkit-scrollbar { display: none; }

        /* =========================================
           2. ANIMATIONS
           ========================================= */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        @keyframes heartBurst { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.4); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* =========================================
           3. UI COMPONENTS
           ========================================= */
        
        /* Header */
        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
            background: rgba(10, 10, 12, 0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end;
            transition: transform 0.3s;
        }
        .header-fixed.hidden { transform: translateY(-100%); }

        .app-logo {
            text-align: center; font-family: 'Unbounded'; font-weight: 800;
            font-size: 0.9rem; letter-spacing: 2px; color: #fff; margin-bottom: 4px;
            cursor: pointer;
        }
        .app-logo span { color: var(--accent); }

        .tabs { display: flex; width: 100%; height: 32px; }
        .tab {
            flex: 1; background: transparent; border: none;
            color: var(--text-muted); font-family: 'Unbounded'; font-weight: 700;
            font-size: 0.75rem; cursor: pointer; transition: 0.3s; position: relative;
        }
        .tab.active { color: #fff; }
        .tab.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%;
            transform: translateX(-50%); width: 24px; height: 3px;
            background: var(--accent); border-radius: 2px;
            box-shadow: 0 -2px 10px var(--accent);
        }

        /* Container */
        .feed-wrapper { max-width: 600px; margin: 0 auto; padding: 15px; position: relative; }

        /* Refresh Indicator */
        .ptr-element {
            height: 0; overflow: hidden; display: flex; align-items: center; justify-content: center;
            transition: height 0.3s; color: var(--accent);
        }
        .ptr-element i { font-size: 1.5rem; animation: spin 1s linear infinite; }

        /* Create Post */
        .composer {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-L); padding: 16px; margin-bottom: 24px;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .composer:active { transform: scale(0.99); }

        .composer-top { display: flex; gap: 12px; align-items: center; }
        .user-ava-sm {
            width: 44px; height: 44px; border-radius: 50%;
            background: #1a1a1d; border: 2px solid #333;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Unbounded'; font-weight: 700; color: #fff;
            flex-shrink: 0; object-fit: cover; font-size: 1rem; overflow: hidden;
        }
        .user-ava-sm img { width: 100%; height: 100%; object-fit: cover; }

        .composer-input {
            flex: 1; background: #000; border: 1px solid var(--border);
            border-radius: 14px; padding: 12px 16px; color: #fff;
            font-family: 'Manrope'; font-size: 0.95rem; transition: 0.3s;
        }
        .composer-input:focus { border-color: var(--accent); }

        .composer-actions {
            display: flex; justify-content: space-between; align-items: center;
            padding-left: 56px; 
        }
        .btn-attach {
            color: var(--text-muted); font-size: 1.4rem; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .btn-attach.has-file { color: var(--accent); }
        .file-label { font-size: 0.75rem; color: #fff; max-width: 100px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        .btn-send {
            background: var(--accent); border: none; width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #000; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 4px 15px var(--accent-glow); transition: 0.2s;
        }
        .btn-send:active { transform: scale(0.9); }

        /* Post Card */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-L); padding: 18px; margin-bottom: 16px;
            position: relative; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .card-user { display: flex; gap: 10px; align-items: center; }
        .card-name { font-weight: 700; font-size: 0.95rem; color: #fff; line-height: 1.2; }
        .card-time { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }
        
        .card-menu { padding: 5px; color: var(--text-muted); cursor: pointer; }

        .card-body {
            font-size: 1rem; line-height: 1.6; color: #eee;
            margin-bottom: 12px; white-space: pre-wrap; word-break: break-word; user-select: text;
        }

        .card-media {
            width: 100%; border-radius: 14px; overflow: hidden;
            margin-bottom: 12px; border: 1px solid #222;
            max-height: 500px; display: flex; justify-content: center; 
            background: #000; position: relative;
        }
        .card-img { width: 100%; height: auto; object-fit: cover; }
        
        /* Like Burst */
        .burst-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            color: #fff; font-size: 6rem; text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            pointer-events: none; z-index: 10;
        }
        .burst-overlay.active { animation: heartBurst 0.6s ease-out; }

        .card-footer {
            display: flex; gap: 24px; padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .action {
            display: flex; align-items: center; gap: 8px;
            color: var(--text-muted); cursor: pointer; transition: 0.2s;
            font-size: 0.9rem; font-weight: 600;
        }
        .action:active { transform: scale(0.95); }
        .action.liked { color: var(--danger); }
        .action.liked i { font-weight: 900; }

        /* =========================================
           4. MODALS & MENUS
           ========================================= */
        /* Dropdown */
        .dropdown {
            position: absolute; top: 40px; right: 10px;
            background: #222; border: 1px solid var(--border);
            border-radius: 12px; width: 160px; display: none; z-index: 50;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); overflow: hidden;
        }
        .dropdown.visible { display: block; animation: fadeIn 0.2s; }
        .dd-item {
            padding: 14px 16px; font-size: 0.85rem; color: #ddd;
            border-bottom: 1px solid #333; cursor: pointer;
        }
        .dd-item:hover { background: #2a2a2e; }
        .dd-item.danger { color: var(--danger); }

        /* Lightbox */
        .lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000; display: none;
            justify-content: center; align-items: center; opacity: 0; transition: 0.3s;
        }
        .lightbox.active { display: flex; opacity: 1; }
        .lb-img { max-width: 100%; max-height: 100%; border-radius: 0; }
        .lb-close {
            position: absolute; top: 20px; right: 20px;
            color: #fff; font-size: 2rem; cursor: pointer;
            background: rgba(0,0,0,0.5); width: 40px; height: 40px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
        }

        /* Comments Sheet */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: flex-end; backdrop-filter: blur(6px);
        }
        .sheet-overlay.active { display: flex; }
        
        .sheet {
            background: #141416; width: 100%; height: 85vh;
            border-radius: 24px 24px 0 0; border-top: 1px solid var(--border);
            display: flex; flex-direction: column; 
            animation: slideUp 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 -20px 60px rgba(0,0,0,0.7);
        }

        .sheet-head {
            padding: 18px; text-align: center; color: #fff; position: relative;
            font-family: 'Unbounded'; font-size: 0.9rem; border-bottom: 1px solid var(--border);
        }
        .sheet-close {
            position: absolute; right: 20px; top: 18px; color: #fff; font-size: 1.2rem;
            background: none; border: none; cursor: pointer;
        }

        .op-preview {
            background: #0f0f11; padding: 12px 16px; border-bottom: 1px solid var(--border);
            display: flex; gap: 12px; align-items: center; opacity: 0.9;
        }
        .op-line { width: 3px; height: 40px; background: var(--accent); border-radius: 2px; }
        .op-text { font-size: 0.85rem; color: #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 85%; }

        .comm-list {
            flex: 1; overflow-y: auto; padding: 16px; 
            display: flex; flex-direction: column; gap: 18px;
        }
        
        .comm-row { display: flex; gap: 10px; position: relative; }
        .comm-bubble {
            background: #1f1f22; padding: 10px 14px; border-radius: 4px 16px 16px 16px;
            color: #ddd; max-width: 85%; border: 1px solid #2a2a2e; position: relative;
        }
        .comm-meta { font-weight: 700; font-size: 0.75rem; color: var(--accent); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .comm-del { color: #444; cursor: pointer; font-size: 1rem; }
        .comm-content { font-size: 0.9rem; line-height: 1.4; word-break: break-word; }
        .comm-media { max-width: 150px; border-radius: 8px; margin-top: 8px; display: block; }
        .sticker-sm { width: 80px; height: 80px; object-fit: contain; margin-top: 5px; }

        /* Sheet Footer */
        .sheet-foot {
            border-top: 1px solid var(--border); background: #141416;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .sticker-tray {
            height: 0; overflow-y: auto; transition: 0.3s;
            background: #1a1a1d; display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 10px; padding: 0 15px; border-bottom: 1px solid var(--border);
        }
        .sticker-tray.open { height: 180px; padding: 15px; }
        .stk-btn { width: 100%; aspect-ratio: 1; cursor: pointer; transition: 0.2s; }
        .stk-btn:active { transform: scale(0.9); }

        .inp-wrap { display: flex; gap: 10px; align-items: center; padding: 12px 16px; }
        .sheet-icon { font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
        .sheet-icon.active { color: var(--accent); }

        /* =========================================
           5. NAVIGATION
           ========================================= */
        .nav-fixed {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px;
            background: var(--bg-nav); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 99; backdrop-filter: blur(12px);
            padding-bottom: 10px;
        }
        .nav-btn { font-size: 1.6rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .nav-btn.active { color: #fff; transform: translateY(-2px); }
        .nav-fab {
            width: 54px; height: 54px; background: var(--accent);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #000; font-size: 1.8rem; transform: translateY(-20%);
            border: 4px solid var(--bg-body); box-shadow: 0 5px 25px rgba(255, 94, 0, 0.4);
            cursor: pointer;
        }

        /* =========================================
           6. UTILITIES
           ========================================= */
        .hidden-file { display: none; }
        
        #toast-box {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            z-index: 6000; display: flex; flex-direction: column; gap: 10px; width: 90%;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto; background: #222; color: #fff; padding: 14px 16px;
            border-radius: 12px; border-left: 4px solid #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 10px;
            animation: slideDown 0.3s; font-size: 0.9rem; font-weight: 600;
        }
        .toast.ok { border-left-color: var(--success); }
        .toast.err { border-left-color: var(--danger); }

    </style>
</head>
<body>

    <audio id="snd-like" src="https://cdn.freesound.org/previews/536/536108_11703666-lq.mp3"></audio>
    <audio id="snd-sent" src="https://cdn.freesound.org/previews/242/242501_4414128-lq.mp3"></audio>

    <div class="lightbox" id="lightbox" onclick="this.classList.remove('active')">
        <div class="lb-close">&times;</div>
        <img src="" class="lb-img" id="lb-img">
    </div>

    <header class="header-fixed" id="app-header">
        <div class="app-logo" onclick="app.refresh()">MEMASIK <span>2.0</span></div>
        <div class="tabs">
            <button class="tab active" onclick="app.switchTab('new')">НОВЫЕ</button>
            <button class="tab" onclick="app.switchTab('top')">ТОП</button>
        </div>
    </header>

    <div class="feed-wrapper">
        <div class="ptr-element" id="ptr"><i class="ri-loader-2-line"></i></div>

        <div class="composer">
            <div class="composer-top">
                <div class="user-ava-sm" id="my-ava">?</div>
                <input type="text" id="post-inp" class="composer-input" placeholder="О чем думаешь?">
            </div>
            <div class="composer-actions">
                <label class="btn-attach" id="attach-btn">
                    <i class="ri-gallery-line"></i> <span id="file-name" class="file-label"></span>
                    <input type="file" id="post-file" class="hidden-file" accept="image/*" onchange="app.handleFile('post')">
                </label>
                <button class="btn-send" onclick="app.sendPost()"><i class="ri-arrow-up-line"></i></button>
            </div>
        </div>

        <div id="feed-list"></div>
        <div id="load-more" style="height:50px;"></div>
    </div>

    <nav class="nav-fixed">
        <div class="nav-btn active" onclick="app.scrollToTop()"><i class="ri-home-5-fill"></i></div>
        <div class="nav-btn"><i class="ri-search-2-line"></i></div>
        <div class="nav-fab" onclick="document.getElementById('post-inp').focus()"><i class="ri-add-line"></i></div>
        <div class="nav-btn"><i class="ri-heart-3-line"></i></div>
        <div class="nav-btn" onclick="window.location.href='profile.html'"><i class="ri-user-3-line"></i></div>
    </nav>

    <div class="sheet-overlay" id="comm-modal">
        <div class="sheet">
            <div class="sheet-head">
                Комментарии
                <button class="sheet-close" onclick="app.closeComm()"><i class="ri-close-line"></i></button>
            </div>
            
            <div id="op-view" class="op-preview"></div>
            <div class="comm-list" id="comm-list"></div>

            <div class="sheet-foot">
                <div class="sticker-tray" id="stk-tray"></div>
                <div class="inp-wrap">
                    <i class="ri-emotion-line sheet-icon" onclick="app.toggleStk()"></i>
                    <label class="sheet-icon">
                        <i class="ri-image-line"></i>
                        <input type="file" id="comm-file" class="hidden-file" accept="image/*" onchange="app.handleFile('comm')">
                    </label>
                    <input type="text" id="comm-inp" class="composer-input" placeholder="Написать..." autocomplete="off">
                    <button class="btn-send" style="width:36px;height:36px" onclick="app.sendComm()"><i class="ri-arrow-up-line"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-box"></div>

    <script>
        /**
         * MEMASIK 2.0 - ULTIMATE CORE (V7.0)
         * Hybrid Architecture: SQL Optimized + JS Fallback + Realtime UX
         */

        const CFG = {
            URL: 'https://hrrzpftxpafnavlljhum.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhycnpwZnR4cGFmbmF2bGxqaHVtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTI3NzU3NiwiZXhwIjoyMDg0ODUzNTc2fQ.5Dt7zXjEF_lVc5Komkg11A4Jy97rxI94PF3UE40X1RE',
            BUCKET: 'memasik_files'
        };

        const STICKERS = [
            'https://cdn-icons-png.flaticon.com/128/742/742751.png', 'https://cdn-icons-png.flaticon.com/128/742/742752.png',
            'https://cdn-icons-png.flaticon.com/128/742/742921.png', 'https://cdn-icons-png.flaticon.com/128/1933/1933691.png',
            'https://cdn-icons-png.flaticon.com/128/616/616430.png', 'https://cdn-icons-png.flaticon.com/128/742/742824.png',
            'https://cdn-icons-png.flaticon.com/128/478/478544.png', 'https://cdn-icons-png.flaticon.com/128/1077/1077035.png'
        ];

        class Core {
            constructor() {
                this.sb = window.supabase.createClient(CFG.URL, CFG.KEY);
                this.me = null;
                this.currPid = null;
                this.cache = {}; // Cache for posts
                this.page = 0;
                this.loading = false;
                this.tab = 'new';
                this.observer = null;

                // Bind UI
                document.addEventListener('click', e => {
                    if(!e.target.closest('.menu-wrap')) document.querySelectorAll('.dropdown').forEach(el => el.classList.remove('visible'));
                });

                this.initStickers();
                this.start();
            }

            initStickers() {
                const tray = document.getElementById('stk-tray');
                STICKERS.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src; img.className = 'stk-btn';
                    img.onclick = () => this.sendStk(src);
                    tray.appendChild(img);
                });
            }

            async start() {
                // Ensure Bucket
                try {
                    const { data } = await this.sb.storage.listBuckets();
                    if(!data.find(b => b.name === CFG.BUCKET)) await this.sb.storage.createBucket(CFG.BUCKET, {public:true});
                } catch(e){}

                // Auth
                const { data: { user } } = await this.sb.auth.getUser();
                if(user) {
                    this.me = user;
                    this.loadProfile();
                }

                // Intersection Observer for Infinite Scroll
                this.observer = new IntersectionObserver((ent) => {
                    if(ent[0].isIntersecting && !this.loading) this.load(this.tab, true);
                }, { threshold: 0.5 });
                this.observer.observe(document.getElementById('load-more'));

                this.load('new');
            }

            async loadProfile() {
                const { data } = await this.sb.from('profiles').select('username, avatar_url').eq('id', this.me.id).single();
                if(data) {
                    const el = document.getElementById('my-ava');
                    if(data.avatar_url) el.innerHTML = `<img src="${data.avatar_url}">`;
                    else el.innerText = (data.username || "U")[0].toUpperCase();
                }
            }

            // === DATA LOADING STRATEGY ===
            async load(type, append = false) {
                if(this.loading) return;
                this.loading = true;
                
                if(!append) {
                    this.page = 0;
                    document.getElementById('feed-list').innerHTML = '';
                    // UI Tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    event?.target.classList.add('active');
                }

                const list = document.getElementById('feed-list');
                const isNew = type === 'new';
                const limit = 10;
                const from = this.page * limit;
                const to = from + limit - 1;

                try {
                    let posts = [];
                    let userMap = {}, likeMap = {}, commMap = {}, myLikes = new Set();

                    // STRATEGY A: SQL FUNCTION (FASTEST)
                    // If you created the SQL function, this runs. If not, it falls back to JS.
                    const { data: sqlData, error: sqlErr } = await this.sb.rpc('get_full_feed', { current_user_id: this.me?.id || '00000000-0000-0000-0000-000000000000' });
                    
                    if (!sqlErr && sqlData) {
                        // Use optimized data
                        posts = sqlData; 
                        // Normalize data structure if needed
                    } else {
                        // STRATEGY B: JS FALLBACK (ROBUST)
                        // 1. Fetch Posts
                        const { data: rawPosts } = await this.sb.from('posts').select('*').order('created_at', {ascending: !isNew}).range(from, to);
                        posts = rawPosts || [];

                        if(posts.length > 0) {
                            const uids = [...new Set(posts.map(p => p.user_id))];
                            const [profs, likes, comms, myL] = await Promise.all([
                                this.sb.from('profiles').select('*').in('id', uids),
                                this.sb.from('likes').select('post_id'),
                                this.sb.from('comments').select('post_id'),
                                this.me ? this.sb.from('likes').select('post_id').eq('user_id', this.me.id) : {data:[]}
                            ]);

                            profs.data?.forEach(p => userMap[p.id] = p);
                            likes.data?.forEach(l => likeMap[l.post_id] = (likeMap[l.post_id]||0)+1);
                            comms.data?.forEach(c => commMap[c.post_id] = (commMap[c.post_id]||0)+1);
                            myL.data?.forEach(l => myLikes.add(l.post_id));
                        }
                    }

                    if(posts.length === 0 && !append) {
                        list.innerHTML = `<div style="text-align:center;padding:50px;color:#555">Пусто...</div>`;
                        return;
                    }

                    // RENDER
                    posts.forEach(p => {
                        this.cache[p.id] = p; // Cache for preview
                        
                        // Handle data source (SQL vs JS)
                        let author = userMap[p.user_id] || { username: p.username, display_name: p.display_name, avatar_url: p.avatar_url };
                        let lCount = p.likes_count !== undefined ? p.likes_count : (likeMap[p.id]||0);
                        let cCount = p.comments_count !== undefined ? p.comments_count : (commMap[p.id]||0);
                        let isLiked = p.is_liked !== undefined ? p.is_liked : myLikes.has(p.id);

                        this.renderPost(p, author, lCount, cCount, isLiked, list);
                    });

                    this.page++;

                } catch(e) {
                    console.error(e);
                    if(!append) list.innerHTML = `<div style="text-align:center;color:red;padding:20px">Ошибка сети</div>`;
                } finally {
                    this.loading = false;
                }
            }

            renderPost(p, author, likes, comms, isLiked, container) {
                const name = author?.display_name || author?.username || 'User';
                const ava = author?.avatar_url ? `<img src="${author.avatar_url}">` : (name[0]||'U').toUpperCase();
                const isMine = this.me && this.me.id === p.user_id;
                const date = this.timeAgo(p.created_at);
                
                let media = '';
                if(p.image_url) {
                    media = `
                    <div class="card-media" ondblclick="app.dblLike('${p.id}')">
                        <i class="ri-heart-3-fill burst-overlay" id="burst-${p.id}"></i>
                        <img src="${p.image_url}" class="card-img" loading="lazy">
                        <div style="position:absolute;bottom:10px;right:10px;background:#0008;padding:5px;border-radius:50%;cursor:pointer" onclick="app.lb('${p.image_url}')"><i class="ri-fullscreen-line" style="color:#fff"></i></div>
                    </div>`;
                }

                const html = `
                <div class="card" id="post-${p.id}">
                    <div class="card-header">
                        <div class="card-user">
                            <div class="user-ava-sm">${ava}</div>
                            <div><div class="card-name">${name}</div><div class="card-time">${date}</div></div>
                        </div>
                        <div class="menu-wrap">
                            <i class="ri-more-fill card-menu" onclick="app.menu('${p.id}')"></i>
                            <div class="dropdown" id="menu-${p.id}">
                                ${isMine ? 
                                    `<div class="dd-item danger" onclick="app.delP('${p.id}')">Удалить</div>` : 
                                    `<div class="dd-item" onclick="app.rep('${p.id}')">Пожаловаться</div>`}
                            </div>
                        </div>
                    </div>
                    <div class="card-body" ondblclick="app.dblLike('${p.id}')">${this.esc(p.content)}</div>
                    ${media}
                    <div class="card-footer">
                        <div class="action ${isLiked?'liked':''}" id="btn-l-${p.id}" onclick="app.like('${p.id}')">
                            <i class="${isLiked?'ri-heart-3-fill':'ri-heart-3-line'}"></i> <span id="cnt-l-${p.id}">${likes}</span>
                        </div>
                        <div class="action" onclick="app.comm('${p.id}')">
                            <i class="ri-chat-1-line"></i> <span>${comms}</span>
                        </div>
                        <div class="action" style="margin-left:auto"><i class="ri-share-forward-line"></i></div>
                    </div>
                </div>`;
                
                const div = document.createElement('div');
                div.innerHTML = html;
                container.appendChild(div.firstElementChild);
            }

            // === ACTIONS ===
            async like(pid) {
                if(!this.me) return this.toast("Войди!", 'err');
                this.vib();
                
                const btn = document.getElementById(`btn-l-${pid}`);
                const span = document.getElementById(`cnt-l-${pid}`);
                const icon = btn.querySelector('i');
                let cnt = parseInt(span.innerText);
                const liked = btn.classList.contains('liked');

                // UI Optimistic
                if(liked) {
                    btn.classList.remove('liked'); icon.className = 'ri-heart-3-line'; span.innerText = cnt-1;
                    await this.sb.from('likes').delete().eq('post_id', pid).eq('user_id', this.me.id);
                } else {
                    btn.classList.add('liked'); icon.className = 'ri-heart-3-fill'; span.innerText = cnt+1;
                    this.play('like');
                    await this.sb.from('likes').insert([{post_id: pid, user_id: this.me.id}]);
                }
            }

            dblLike(pid) {
                const burst = document.getElementById(`burst-${pid}`);
                if(burst) {
                    burst.classList.add('active');
                    setTimeout(()=>burst.classList.remove('active'), 600);
                }
                const btn = document.getElementById(`btn-l-${pid}`);
                if(!btn.classList.contains('liked')) this.like(pid);
                else this.vib();
            }

            // === COMMENTS (FIXED) ===
            async comm(pid) {
                this.currPid = pid;
                const modal = document.getElementById('comm-modal');
                const list = document.getElementById('comm-list');
                const prev = document.getElementById('op-view');
                
                modal.classList.add('active');
                list.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Загрузка...</div>';

                // Preview
                const post = this.cache[pid];
                if(post) {
                    const txt = post.content.length > 50 ? post.content.slice(0,50)+'...' : post.content;
                    prev.innerHTML = `<div class="op-line"></div><div class="op-text"><b>Пост:</b> ${this.esc(txt)}</div>`;
                }

                // Load
                try {
                    // Используем уникальное имя переменной, чтобы избежать конфликтов
                    const { data: commentsList, error } = await this.sb.from('comments').select('*').eq('post_id', pid).order('created_at');
                    
                    if(error) throw error;

                    if(!commentsList || !commentsList.length) {
                        list.innerHTML = '<div style="text-align:center;padding:20px;color:#555">Нет комментариев</div>';
                        return;
                    }

                    // Authors
                    const uids = [...new Set(commentsList.map(c => c.user_id))];
                    const { data: profs } = await this.sb.from('profiles').select('*').in('id', uids);
                    const map = {};
                    profs?.forEach(p => map[p.id] = p);

                    list.innerHTML = '';
                    commentsList.forEach(c => {
                        const auth = map[c.user_id] || {};
                        const name = auth.display_name || auth.username || 'User';
                        const isMine = this.me && this.me.id === c.user_id;
                        
                        let media = '';
                        if(c.image_url) {
                            const cls = c.content === 'Sticker' ? 'sticker-sm' : 'comm-media';
                            media = `<img src="${c.image_url}" class="${cls}" onclick="app.lb(this.src)">`;
                        }

                        const html = `
                        <div class="comm-row" id="c-${c.id}">
                            <div class="user-ava-sm" style="width:32px;height:32px;font-size:0.7rem">${(name[0]||'U').toUpperCase()}</div>
                            <div class="comm-bubble">
                                <div class="comm-meta">
                                    <span>${name}</span>
                                    ${isMine ? `<i class="ri-close-line comm-del" onclick="app.delC('${c.id}')"></i>` : ''}
                                </div>
                                <div class="comm-content">${this.esc(c.content)}</div>
                                ${media}
                            </div>
                        </div>`;
                        list.innerHTML += html;
                    });
                    
                    list.scrollTop = list.scrollHeight;

                } catch(e) {
                    list.innerHTML = `<div style="text-align:center;color:red">Ошибка: ${e.message}</div>`;
                }
            }

            async sendComm() {
                if(!this.me) return this.toast('Войди!', 'err');
                const inp = document.getElementById('comm-inp');
                const fileInp = document.getElementById('comm-file');
                const val = inp.value.trim();
                const file = fileInp.files[0];

                if(!val && !file) return;

                try {
                    let url = null;
                    if(file) url = await this.upl(file);

                    await this.sb.from('comments').insert([{
                        post_id: this.currPid,
                        user_id: this.me.id,
                        content: val || "Pic",
                        image_url: url
                    }]);

                    inp.value = ''; fileInp.value = '';
                    this.play('sent');
                    this.comm(this.currPid); // Refresh
                } catch(e) { this.toast(e.message, 'err'); }
            }

            async sendStk(url) {
                if(!this.me) return this.toast('Войди!', 'err');
                await this.sb.from('comments').insert([{
                    post_id: this.currPid, user_id: this.me.id, content: "Sticker", image_url: url
                }]);
                this.toggleStk();
                this.comm(this.currPid);
                this.play('sent');
            }

            // === POST ===
            async sendPost() {
                if(!this.me) return this.toast('Войди!', 'err');
                const inp = document.getElementById('post-inp');
                const fileInp = document.getElementById('post-file');
                const val = inp.value.trim();
                const file = fileInp.files[0];

                if(!val && !file) return;

                const btn = document.querySelector('.btn-send');
                btn.style.opacity = 0.5;

                try {
                    let url = null;
                    if(file) {
                        this.toast('Загрузка...', 'ok');
                        url = await this.upl(file);
                    }

                    await this.sb.from('posts').insert([{
                        user_id: this.me.id, content: val || " ", image_url: url
                    }]);

                    inp.value = ''; fileInp.value = '';
                    document.getElementById('file-name').innerText = '';
                    document.getElementById('attach-btn').classList.remove('has-file');
                    this.play('sent');
                    this.toast('Опубликовано', 'ok');
                    this.load('new');
                } catch(e) { this.toast(e.message, 'err'); }
                finally { btn.style.opacity = 1; }
            }

            // === UTILS ===
            async upl(file) {
                const ext = file.name.split('.').pop();
                const path = `${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
                const { error } = await this.sb.storage.from(CFG.BUCKET).upload(path, file);
                if(error) throw error;
                return this.sb.storage.from(CFG.BUCKET).getPublicUrl(path).data.publicUrl;
            }

            handleFile(t) {
                const f = document.getElementById(t==='post'?'post-file':'comm-file').files[0];
                if(t==='post' && f) {
                    document.getElementById('attach-btn').classList.add('has-file');
                    document.getElementById('file-name').innerText = f.name;
                }
            }

            async delP(id) {
                if(confirm('Удалить?')) {
                    await this.sb.from('posts').delete().eq('id', id);
                    document.getElementById(`post-${id}`).remove();
                    this.toast('Удалено', 'ok');
                }
            }
            async delC(id) {
                if(confirm('Удалить?')) {
                    await this.sb.from('comments').delete().eq('id', id);
                    document.getElementById(`c-${id}`).remove();
                }
            }

            menu(id) {
                document.querySelectorAll('.dropdown').forEach(e => e.classList.remove('visible'));
                document.getElementById(`menu-${id}`).classList.add('visible');
            }
            
            toggleStk() { document.getElementById('stk-tray').classList.toggle('open'); }
            closeComm() { document.getElementById('comm-modal').classList.remove('active'); }
            lb(src) { document.getElementById('lb-img').src = src; document.getElementById('lightbox').classList.add('active'); }
            
            toast(m, t) {
                const b = document.getElementById('toast-box');
                const d = document.createElement('div');
                d.className = `toast ${t}`; d.innerText = m;
                b.appendChild(d); setTimeout(()=>d.remove(), 3000);
            }

            play(t) { document.getElementById(t==='like'?'snd-like':'snd-sent').play().catch(()=>{}); }
            vib() { if(navigator.vibrate) navigator.vibrate(10); }
            refresh() { this.load('new'); }
            scrollToTop() { window.scrollTo(0,0); }
            switchTab(t) { this.load(t); }
            esc(t) { return t ? t.replace(/</g, "&lt;") : ""; }
            
            timeAgo(d) {
                const s = Math.floor((new Date()-new Date(d))/1000);
                if(s<60) return "сейчас";
                if(s<3600) return Math.floor(s/60)+"м";
                if(s<86400) return Math.floor(s/3600)+"ч";
                return new Date(d).toLocaleDateString();
            }
        }

        const app = new Core();
    </script>
</body>
</html>
