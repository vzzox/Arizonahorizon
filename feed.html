<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEMASIK 2.0 | FEED</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Unbounded:wght@500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* === VARIABLES === */
        :root {
            --bg: #0a0a0c; --card: #141416; --border: #2a2a2e;
            --accent: #ff5e00; --text: #fff; --muted: #888;
            --font-main: 'Manrope'; --font-head: 'Unbounded';
        }

        /* === RESET & BASE === */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: var(--font-main); padding-bottom: 80px; padding-top: 60px; }
        
        /* ШУМ */
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); opacity: 0.5; pointer-events: none; z-index: -1; }

        /* === HEADER === */
        .header { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(10,10,12,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .tabs { display: flex; gap: 20px; }
        .tab { background: none; border: none; color: var(--muted); font-family: var(--font-head); font-weight: 700; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; }
        .tab.active { color: #fff; border-bottom: 2px solid var(--accent); }

        /* === FEED & POSTS === */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* Create Post */
        .create-box { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-family: var(--font-head); font-weight: 700; flex-shrink: 0; }
        .input { width: 100%; background: #000; border: 1px solid var(--border); color: #fff; padding: 10px 15px; border-radius: 20px; font-family: var(--font-main); }
        .send-btn { color: var(--accent); font-size: 1.5rem; cursor: pointer; }

        /* Post Card */
        .post { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 15px; margin-bottom: 12px; position: relative; }
        .post-head { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .user-info { display: flex; gap: 10px; align-items: center; }
        .username { font-weight: 700; font-size: 0.9rem; }
        .time { font-size: 0.75rem; color: var(--muted); }
        
        .menu-btn { color: var(--muted); cursor: pointer; padding: 5px; }
        /* Меню удаления */
        .delete-menu { position: absolute; top: 40px; right: 15px; background: #220000; border: 1px solid #ff3333; padding: 8px 15px; border-radius: 8px; color: #ff3333; font-size: 0.8rem; font-weight: 700; display: none; cursor: pointer; z-index: 10; }
        
        .content { font-size: 0.95rem; line-height: 1.5; color: #eee; margin-bottom: 15px; white-space: pre-wrap; word-break: break-word; }
        
        .actions { display: flex; gap: 20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px; }
        .act { display: flex; align-items: center; gap: 6px; color: var(--muted); cursor: pointer; transition: 0.2s; }
        .act:hover { color: #fff; }
        .act.liked { color: #ff3333; } /* Красное сердце */
        .act i { font-size: 1.2rem; }

        /* === MODAL (COMMENTS) === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; }
        .modal { width: 100%; max-width: 600px; height: 80vh; background: #1a1a1c; border-radius: 20px 20px 0 0; margin: 0 auto; display: flex; flex-direction: column; animation: slideUp 0.3s ease; border-top: 1px solid var(--accent); }
        .modal-header { padding: 15px; text-align: center; border-bottom: 1px solid var(--border); position: relative; font-family: var(--font-head); font-weight: 700; }
        .close-modal { position: absolute; right: 15px; top: 15px; font-size: 1.5rem; cursor: pointer; }
        
        .comments-list { flex: 1; overflow-y: auto; padding: 15px; }
        .comment-item { margin-bottom: 15px; font-size: 0.9rem; }
        .comment-user { font-weight: 700; color: var(--accent); font-size: 0.8rem; margin-bottom: 2px; }
        
        .comment-input-area { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #141416; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* === NAV & TOAST === */
        .nav { position: fixed; bottom: 0; width: 100%; height: 65px; background: rgba(18,18,20,0.95); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 100; backdrop-filter: blur(10px); }
        .nav i { font-size: 1.5rem; color: var(--muted); cursor: pointer; }
        .nav i.active { color: #fff; }
        .add-btn { background: var(--accent); color: #000; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: translateY(-15px); border: 3px solid var(--bg); font-size: 1.5rem; }

        #toast-box { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 3000; }
        .toast { background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent); animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="tabs">
            <button class="tab active" onclick="app.loadFeed()">ЛЕНТА</button>
            <button class="tab">ТОП</button>
        </div>
    </div>

    <div class="container">
        <div class="create-box">
            <div class="avatar" id="my-avatar">?</div>
            <input type="text" id="new-post" class="input" placeholder="Что нового?">
            <i class="ri-send-plane-fill send-btn" onclick="app.sendPost()"></i>
        </div>
        <div id="feed"></div>
    </div>

    <div class="modal-overlay" id="comments-modal">
        <div class="modal">
            <div class="modal-header">
                Комментарии
                <i class="ri-close-line close-modal" onclick="app.closeComments()"></i>
            </div>
            <div class="comments-list" id="comments-list">
                </div>
            <div class="comment-input-area">
                <input type="text" id="comment-input" class="input" placeholder="Написать комментарий...">
                <i class="ri-send-plane-fill send-btn" onclick="app.sendComment()"></i>
            </div>
        </div>
    </div>

    <nav class="nav">
        <i class="ri-home-5-fill active"></i>
        <i class="ri-search-2-line"></i>
        <div class="add-btn" onclick="document.getElementById('new-post').focus()"><i class="ri-add-line"></i></div>
        <i class="ri-heart-3-line"></i>
        <i class="ri-user-3-line" onclick="window.location.href='index.html'"></i>
    </nav>

    <div id="toast-box"></div>

    <script>
        // === CONFIG (Service Role Key) ===
        const SUPABASE_URL = 'https://hrrzpftxpafnavlljhum.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhycnpwZnR4cGFmbmF2bGxqaHVtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTI3NzU3NiwiZXhwIjoyMDg0ODUzNTc2fQ.5Dt7zXjEF_lVc5Komkg11A4Jy97rxI94PF3UE40X1RE';

        class App {
            constructor() {
                this.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                this.user = null;
                this.currentPostId = null; // Для комментариев
                this.init();
            }

            async init() {
                try {
                    const { data: { user } } = await this.sb.auth.getUser();
                    if (user) {
                        this.user = user;
                        this.loadAvatar();
                    }
                    this.loadFeed();
                } catch (e) { this.toast(e.message); }
            }

            async loadAvatar() {
                const { data } = await this.sb.from('profiles').select('username').eq('id', this.user.id).single();
                if (data) document.getElementById('my-avatar').innerText = data.username[0].toUpperCase();
            }

            // --- FEED LOGIC ---
            async loadFeed() {
                const feed = document.getElementById('feed');
                feed.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Загрузка...</div>';
                
                // 1. Грузим посты
                const { data: posts } = await this.sb.from('posts').select('*').order('created_at', { ascending: false });
                
                if (!posts || !posts.length) {
                    feed.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Лента пуста</div>';
                    return;
                }

                // 2. Грузим доп данные (Профили + Лайки)
                const userIds = [...new Set(posts.map(p => p.user_id))];
                const postIds = posts.map(p => p.id);

                // Запросы параллельно для скорости
                const [profilesRes, likesRes, commentsRes] = await Promise.all([
                    this.sb.from('profiles').select('id, username').in('id', userIds),
                    this.sb.from('likes').select('post_id, user_id').in('post_id', postIds),
                    this.sb.from('comments').select('post_id').in('post_id', postIds)
                ]);

                // Маппинг данных
                const users = {}; 
                profilesRes.data?.forEach(p => users[p.id] = p.username);

                // Рендер
                feed.innerHTML = '';
                posts.forEach(post => {
                    const username = users[post.user_id] || 'Аноним';
                    const avatar = username[0].toUpperCase();
                    
                    // Лайки
                    const postLikes = likesRes.data?.filter(l => l.post_id === post.id) || [];
                    const countLikes = postLikes.length;
                    const isLiked = this.user && postLikes.some(l => l.user_id === this.user.id);
                    
                    // Комменты
                    const countComments = commentsRes.data?.filter(c => c.post_id === post.id).length || 0;

                    // Кнопка удаления (только если я автор)
                    const deleteHtml = (this.user && this.user.id === post.user_id) 
                        ? `<div class="menu-btn" onclick="app.toggleMenu('${post.id}')"><i class="ri-more-2-fill"></i></div>
                           <div class="delete-menu" id="menu-${post.id}" onclick="app.deletePost('${post.id}')">Удалить пост</div>` 
                        : '';

                    const html = `
                    <div class="post" id="post-${post.id}">
                        <div class="post-head">
                            <div class="user-info">
                                <div class="avatar">${avatar}</div>
                                <div>
                                    <div class="username">${username}</div>
                                    <div class="time">Только что</div>
                                </div>
                            </div>
                            <div style="position:relative;">
                                ${deleteHtml}
                            </div>
                        </div>
                        <div class="content">${this.escape(post.content)}</div>
                        <div class="actions">
                            <div class="act ${isLiked ? 'liked' : ''}" onclick="app.toggleLike('${post.id}', this)">
                                <i class="${isLiked ? 'ri-heart-3-fill' : 'ri-heart-3-line'}"></i> 
                                <span>${countLikes}</span>
                            </div>
                            <div class="act" onclick="app.openComments('${post.id}')">
                                <i class="ri-chat-3-line"></i>
                                <span>${countComments}</span>
                            </div>
                        </div>
                    </div>`;
                    feed.innerHTML += html;
                });
            }

            // --- ACTIONS ---
            async sendPost() {
                if (!this.user) return this.toast("Нужна регистрация!");
                const inp = document.getElementById('new-post');
                if (!inp.value.trim()) return;

                await this.sb.from('posts').insert([{ user_id: this.user.id, content: inp.value }]);
                inp.value = '';
                this.loadFeed();
            }

            async toggleLike(postId, el) {
                if (!this.user) return this.toast("Войди в аккаунт");
                
                // Визуально меняем сразу (оптимистичный UI)
                const icon = el.querySelector('i');
                const span = el.querySelector('span');
                let count = parseInt(span.innerText);
                
                if (el.classList.contains('liked')) {
                    // Убираем лайк
                    el.classList.remove('liked');
                    icon.className = 'ri-heart-3-line';
                    span.innerText = count - 1;
                    await this.sb.from('likes').delete().match({ post_id: postId, user_id: this.user.id });
                } else {
                    // Ставим лайк
                    el.classList.add('liked');
                    icon.className = 'ri-heart-3-fill';
                    span.innerText = count + 1;
                    await this.sb.from('likes').insert([{ post_id: postId, user_id: this.user.id }]);
                }
            }

            toggleMenu(id) {
                const menu = document.getElementById(`menu-${id}`);
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }

            async deletePost(id) {
                if(!confirm("Удалить пост?")) return;
                await this.sb.from('posts').delete().eq('id', id);
                document.getElementById(`post-${id}`).remove();
                this.toast("Пост удален");
            }

            // --- COMMENTS ---
            async openComments(postId) {
                this.currentPostId = postId;
                document.getElementById('comments-modal').style.display = 'flex';
                const list = document.getElementById('comments-list');
                list.innerHTML = '<div style="color:#666; text-align:center">Загрузка...</div>';

                // Грузим комменты и имена
                const { data: comments } = await this.sb.from('comments').select('*').eq('post_id', postId).order('created_at');
                
                if(!comments.length) {
                    list.innerHTML = '<div style="color:#666; text-align:center">Нет комментариев. Будь первым!</div>';
                    return;
                }

                // Имена комментаторов
                const uids = [...new Set(comments.map(c => c.user_id))];
                const { data: profiles } = await this.sb.from('profiles').select('id, username').in('id', uids);
                const userMap = {};
                profiles?.forEach(p => userMap[p.id] = p.username);

                list.innerHTML = '';
                comments.forEach(c => {
                    list.innerHTML += `
                        <div class="comment-item">
                            <div class="comment-user">${userMap[c.user_id] || 'Anon'}</div>
                            <div>${this.escape(c.content)}</div>
                        </div>`;
                });
            }

            async sendComment() {
                if (!this.user) return this.toast("Нужна регистрация");
                const inp = document.getElementById('comment-input');
                if (!inp.value.trim()) return;

                await this.sb.from('comments').insert([{
                    post_id: this.currentPostId,
                    user_id: this.user.id,
                    content: inp.value
                }]);
                
                inp.value = '';
                this.openComments(this.currentPostId); // Перезагрузить список
            }

            closeComments() {
                document.getElementById('comments-modal').style.display = 'none';
            }

            // --- UTILS ---
            toast(msg) {
                const box = document.getElementById('toast-box');
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerText = msg;
                box.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }
            escape(s) { return s ? s.replace(/</g, "&lt;") : ""; }
        }

        const app = new App();
    </script>
</body>
</html>
