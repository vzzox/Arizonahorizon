<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEMASIK 2.0 | GOD MODE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Manrope:wght@400;600;800&family=Unbounded:wght@500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0f0f11;
            --bg-hover: #1a1a1d;
            --border: #2a2a2e;
            
            --accent: #ff5e00;
            --accent-dim: rgba(255, 94, 0, 0.1);
            
            --text-main: #fff;
            --text-gray: #888;
            
            --danger: #ff3333;
            --success: #00ff88;
            --warn: #ffcc00;
            --info: #0088ff;
            
            --font-ui: 'Manrope', sans-serif;
            --font-head: 'Unbounded', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- MOBILE OVERLAY & TOGGLE --- */
        .mobile-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 90; backdrop-filter: blur(5px);
            display: none; opacity: 0; transition: 0.3s;
        }
        .mobile-overlay.open { display: block; opacity: 1; }

        .mobile-btn {
            display: none; font-size: 1.5rem; color: #fff; margin-right: 15px; cursor: pointer;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 20px;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .brand {
            font-family: var(--font-head);
            font-size: 1.2rem; color: var(--accent);
            margin-bottom: 30px; letter-spacing: 1px;
            display: flex; align-items: center; gap: 10px;
        }
        .brand span { color: #fff; font-size: 0.8rem; background: var(--border); padding: 2px 6px; border-radius: 4px; }

        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 5px; flex: 1; overflow-y: auto; }
        .nav-item {
            padding: 12px 15px; border-radius: 8px; cursor: pointer;
            color: var(--text-gray); transition: 0.2s; font-weight: 600;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover { background: var(--bg-hover); color: #fff; }
        .nav-item.active { background: var(--accent); color: #000; }
        .nav-item i { font-size: 1.2rem; }

        .admin-profile {
            border-top: 1px solid var(--border);
            padding-top: 15px; margin-top: 15px;
            display: flex; align-items: center; gap: 10px;
        }
        .admin-ava { width: 40px; height: 40px; border-radius: 50%; background: #333; object-fit: cover; }
        .admin-info h4 { font-size: 0.9rem; margin-bottom: 2px; }
        .role-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; }

        /* ROLE COLORS */
        .role-owner { color: #ff0055; border: 1px solid #ff0055; background: #22000a; }
        .role-dev { color: #00ccff; border: 1px solid #00ccff; background: #001122; }
        .role-sadmin { color: #aa00ff; border: 1px solid #aa00ff; background: #110022; }
        .role-admin { color: #ff5e00; border: 1px solid #ff5e00; background: #220a00; }
        .role-smod { color: #00ff88; border: 1px solid #00ff88; background: #002211; }
        .role-mod { color: #ffff00; border: 1px solid #ffff00; background: #222200; }
        .role-user { color: #888; border: 1px solid #444; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; width: 100%; }
        
        .top-bar { display: flex; align-items: center; margin-bottom: 30px; }
        .page-title { font-family: var(--font-head); font-size: 1.8rem; flex: 1; }
        .server-status { font-family: var(--font-code); font-size: 0.8rem; color: var(--success); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }

        /* --- DASHBOARD WIDGETS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 20px; border-radius: 16px; position: relative; overflow: hidden;
        }
        .stat-card h3 { font-size: 0.8rem; color: var(--text-gray); text-transform: uppercase; margin-bottom: 10px; }
        .stat-card .value { font-family: var(--font-head); font-size: 2rem; color: #fff; }
        .stat-icon { position: absolute; right: 20px; top: 20px; font-size: 2.5rem; opacity: 0.1; }

        .chart-container {
            background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px; height: 400px; margin-bottom: 30px;
        }

        /* --- TABLES & CONTENT --- */
        .table-container {
            background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: 16px; overflow: hidden; overflow-x: auto;
        }
        .toolbar { padding: 20px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        
        .search-inp, .db-select {
            background: #000; border: 1px solid var(--border); color: #fff;
            padding: 10px 15px; border-radius: 8px; font-family: var(--font-ui);
        }
        
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 600px; }
        th { padding: 15px 20px; color: var(--text-gray); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px 20px; border-bottom: 1px solid #222; font-size: 0.9rem; vertical-align: middle; }
        tr:hover { background: var(--bg-hover); }
        
        .action-btn {
            padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer;
            font-size: 0.8rem; font-weight: 700; margin-right: 5px; transition: 0.2s;
        }
        .action-btn:hover { opacity: 0.8; }
        .btn-edit { background: #222; color: #fff; border: 1px solid var(--border); }
        .btn-ban { background: rgba(255, 51, 51, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-view { background: rgba(0, 136, 255, 0.1); color: var(--info); border: 1px solid var(--info); }

        /* Content Previews */
        .content-preview-img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #333; }
        .content-text-short { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* DB Raw View */
        .raw-json { font-family: var(--font-code); font-size: 0.8rem; color: #aaa; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        
        .modal {
            background: var(--bg-panel); width: 90%; max-width: 500px; border-radius: 16px;
            border: 1px solid var(--border); padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .modal-title { font-family: var(--font-head); font-size: 1.4rem; }
        .close-modal { cursor: pointer; font-size: 1.5rem; color: var(--text-gray); }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-gray); font-size: 0.9rem; }
        .form-input, .form-select {
            width: 100%; padding: 12px; background: #000; border: 1px solid var(--border);
            color: #fff; border-radius: 8px; font-family: var(--font-ui);
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-primary { 
            padding: 12px 24px; background: var(--accent); color: #000; 
            border: none; border-radius: 8px; font-weight: 800; cursor: pointer; 
        }

        /* --- TOASTS --- */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            background: #222; border-left: 4px solid var(--accent); color: #fff;
            padding: 15px 20px; border-radius: 8px; margin-top: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s;
            display: flex; align-items: center; gap: 10px;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* VIEW SECTIONS */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* LOGS */
        .log-entry { font-family: var(--font-code); font-size: 0.8rem; padding: 10px; border-bottom: 1px solid #222; color: #aaa; }
        .log-time { color: var(--accent); margin-right: 10px; }
        .log-action { color: #fff; font-weight: 700; margin-right: 10px; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; }
            .sidebar.open { transform: translateX(260px); left: 0; }
            .mobile-btn { display: block; }
            .main { padding: 15px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .table-container { overflow-x: scroll; }
        }
    </style>
</head>
<body>

    <div class="mobile-overlay" id="mobile-overlay" onclick="app.toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="brand">
            <i class="ri-shield-flash-fill"></i> MEMASIK <span>GOD</span>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item active" onclick="app.nav('dashboard')">
                <i class="ri-dashboard-3-line"></i> Дашборд
            </li>
            <li class="nav-item" onclick="app.nav('users')">
                <i class="ri-group-line"></i> Пользователи
            </li>
            <li class="nav-item" onclick="app.nav('content')">
                <i class="ri-image-2-line"></i> Контент
            </li>
            <li class="nav-item" onclick="app.nav('database')">
                <i class="ri-database-2-line"></i> База Данных
            </li>
            <li class="nav-item" onclick="app.nav('reports')">
                <i class="ri-alarm-warning-line"></i> Жалобы
            </li>
            <li class="nav-item" onclick="app.nav('logs')">
                <i class="ri-file-list-3-line"></i> Логи
            </li>
        </ul>

        <div class="admin-profile">
            <img src="" class="admin-ava" id="adm-ava">
            <div class="admin-info">
                <h4 id="adm-name">Loading...</h4>
                <span class="role-badge role-user" id="adm-role">CHECKING</span>
            </div>
        </div>
    </div>

    <div class="main">
        
        <div class="top-bar">
            <i class="ri-menu-line mobile-btn" onclick="app.toggleSidebar()"></i>
            <h1 class="page-title" id="page-title">Дашборд</h1>
            <div class="server-status">
                <div class="status-dot"></div> ONLINE
            </div>
        </div>

        <div id="view-dashboard" class="view-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Всего юзеров</h3>
                    <div class="value" id="stat-users">0</div>
                    <i class="ri-user-line stat-icon"></i>
                </div>
                <div class="stat-card">
                    <h3>Всего постов</h3>
                    <div class="value" id="stat-posts">0</div>
                    <i class="ri-article-line stat-icon"></i>
                </div>
                <div class="stat-card">
                    <h3>Жалобы</h3>
                    <div class="value" style="color:var(--danger)" id="stat-reports">0</div>
                    <i class="ri-alert-line stat-icon"></i>
                </div>
                <div class="stat-card">
                    <h3>DB Latency</h3>
                    <div class="value" style="color:var(--success)">24ms</div>
                    <i class="ri-pulse-line stat-icon"></i>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div id="view-users" class="view-section">
            <div class="table-container">
                <div class="toolbar">
                    <input type="text" class="search-inp" placeholder="Поиск (ID, Ник)..." oninput="app.searchUser(this.value)">
                    <button class="action-btn btn-view" onclick="app.loadUsers()"><i class="ri-refresh-line"></i></button>
                </div>
                <table>
                    <thead><tr><th>User</th><th>Role</th><th>Date</th><th>Actions</th></tr></thead>
                    <tbody id="users-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-content" class="view-section">
            <div class="table-container">
                <div class="toolbar">
                    <span>Управление постами</span>
                    <button class="action-btn btn-view" onclick="app.loadContent()"><i class="ri-refresh-line"></i> Обновить</button>
                </div>
                <table>
                    <thead><tr><th>ID</th><th>Автор</th><th>Превью</th><th>Дата</th><th>Действие</th></tr></thead>
                    <tbody id="content-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-database" class="view-section">
            <div class="table-container">
                <div class="toolbar">
                    <select class="db-select" id="db-table-select" onchange="app.loadDatabase(this.value)">
                        <option value="profiles">profiles (users)</option>
                        <option value="posts">posts</option>
                        <option value="comments">comments</option>
                        <option value="likes">likes</option>
                        <option value="reports">reports</option>
                        <option value="admin_logs">admin_logs</option>
                        <option value="notifications">notifications</option>
                        <option value="messages">messages</option>
                    </select>
                    <span style="font-family: var(--font-code); font-size: 0.8rem; color: var(--warn)">RAW MODE</span>
                </div>
                <div style="overflow-x:auto;">
                    <table id="db-raw-table">
                        <thead id="db-thead"></thead>
                        <tbody id="db-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section">
            <div class="table-container">
                <div class="toolbar"><span>Активные жалобы</span></div>
                <table>
                    <thead><tr><th>From</th><th>Type</th><th>Target ID</th><th>Reason</th><th>Actions</th></tr></thead>
                    <tbody id="reports-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-logs" class="view-section">
            <div class="table-container" style="background: #000; padding: 20px; font-family: monospace;">
                <div id="logs-container"></div>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="modal-user">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Редактирование</div>
                <i class="ri-close-line close-modal" onclick="app.closeModal()"></i>
            </div>
            <div class="form-group">
                <label class="form-label">Никнейм</label>
                <input type="text" class="form-input" id="edit-username" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Роль</label>
                <select class="form-select" id="edit-role">
                    <option value="user">User</option>
                    <option value="mod">Moderator</option>
                    <option value="smod">Senior Moderator</option>
                    <option value="admin">Administrator</option>
                    <option value="sadmin">Senior Administrator</option>
                    <option value="dev">Developer</option>
                    <option value="owner">Owner</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="action-btn btn-ban" onclick="app.banUser()">УДАЛИТЬ ЮЗЕРА</button>
                <button class="btn-primary" onclick="app.saveUser()">Сохранить</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script>
        const CONFIG = {
            URL: 'https://hrrzpftxpafnavlljhum.supabase.co',
            // ADMIN KEY (SERVICE ROLE)
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhycnpwZnR4cGFmbmF2bGxqaHVtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTI3NzU3NiwiZXhwIjoyMDg0ODUzNTc2fQ.5Dt7zXjEF_lVc5Komkg11A4Jy97rxI94PF3UE40X1RE'
        };

        const ROLES_POWER = { 'owner': 100, 'dev': 90, 'sadmin': 80, 'admin': 70, 'smod': 60, 'mod': 50, 'user': 0 };

        class AdminPanel {
            constructor() {
                this.sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
                this.me = null;
                this.myPower = 0;
                this.usersCache = [];
                this.targetUserId = null;
                this.init();
            }

            async init() {
                const { data: { user } } = await this.sb.auth.getUser();
                if(!user) return window.location.href = 'index.html';
                this.me = user;
                
                await this.loadMyProfile();
                this.renderDashboard();
                this.loadUsers();
            }

            async loadMyProfile() {
                const { data } = await this.sb.from('profiles').select('*').eq('id', this.me.id).single();
                // Backdoor for first setup
                if (this.me.email === 'vzzox@admin.com' && data.role !== 'owner') {
                    await this.sb.from('profiles').update({role: 'owner'}).eq('id', this.me.id);
                    data.role = 'owner';
                }
                
                this.myPower = ROLES_POWER[data.role || 'user'];
                if(this.myPower < 50) {
                    document.body.innerHTML = '<h1 style="color:red;text-align:center;margin-top:20%">ACCESS DENIED</h1>';
                    throw new Error("Forbidden");
                }

                document.getElementById('adm-name').innerText = data.username;
                const badge = document.getElementById('adm-role');
                badge.innerText = (data.role || 'USER').toUpperCase();
                badge.className = `role-badge role-${data.role || 'user'}`;
                if(data.avatar_url) document.getElementById('adm-ava').src = data.avatar_url;
            }

            // === DASHBOARD ===
            async renderDashboard() {
                const [u, p, r] = await Promise.all([
                    this.sb.from('profiles').select('*', { count: 'exact', head: true }),
                    this.sb.from('posts').select('*', { count: 'exact', head: true }),
                    this.sb.from('reports').select('*', { count: 'exact', head: true }).eq('status', 'open')
                ]);
                document.getElementById('stat-users').innerText = u.count;
                document.getElementById('stat-posts').innerText = p.count;
                document.getElementById('stat-reports').innerText = r.count;

                const ctx = document.getElementById('mainChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{ label: 'Activity', data: [10, 25, 15, 30, 20, 45, 60], borderColor: '#ff5e00', tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales:{x:{grid:{color:'#222'}}, y:{grid:{color:'#222'}}} }
                });
            }

            // === USERS ===
            async loadUsers() {
                const { data } = await this.sb.from('profiles').select('*').order('created_at', {ascending:false}).limit(50);
                this.usersCache = data;
                this.renderUsers(data);
            }
            renderUsers(users) {
                const tb = document.getElementById('users-tbody');
                tb.innerHTML = '';
                users.forEach(u => {
                    tb.innerHTML += `<tr>
                        <td><b>${u.username}</b><br><small style="color:#666">${u.id.slice(0,8)}</small></td>
                        <td><span class="role-badge role-${u.role||'user'}">${u.role||'user'}</span></td>
                        <td>${new Date(u.created_at).toLocaleDateString()}</td>
                        <td><button class="action-btn btn-edit" onclick="app.editUser('${u.id}')">EDIT</button></td>
                    </tr>`;
                });
            }
            searchUser(q) {
                const res = this.usersCache.filter(u => u.username.toLowerCase().includes(q.toLowerCase()) || u.id.includes(q));
                this.renderUsers(res);
            }
            editUser(uid) {
                const u = this.usersCache.find(x => x.id === uid);
                if(ROLES_POWER[u.role] >= this.myPower && this.me.id !== uid) return this.toast('Недостаточно прав', 'err');
                this.targetUserId = uid;
                document.getElementById('edit-username').value = u.username;
                document.getElementById('edit-role').value = u.role || 'user';
                document.getElementById('modal-user').classList.add('open');
            }
            async saveUser() {
                const role = document.getElementById('edit-role').value;
                if(ROLES_POWER[role] >= this.myPower && this.me.id !== this.targetUserId) return this.toast('Нельзя выдать роль выше своей', 'err');
                await this.sb.from('profiles').update({role}).eq('id', this.targetUserId);
                await this.log('change_role', this.targetUserId, `Role: ${role}`);
                this.toast('Сохранено', 'ok');
                this.closeModal();
                this.loadUsers();
            }
            async banUser() {
                if(!confirm('Удалить пользователя навсегда?')) return;
                await this.sb.from('profiles').delete().eq('id', this.targetUserId);
                await this.log('ban_user', this.targetUserId, 'Deleted');
                this.toast('Пользователь удален', 'ok');
                this.closeModal();
                this.loadUsers();
            }

            // === CONTENT MANAGER (FIXED) ===
            async loadContent() {
                const tb = document.getElementById('content-tbody');
                tb.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
                
                // Get posts + authors
                const { data: posts } = await this.sb.from('posts').select('*').order('created_at', {ascending:false}).limit(20);
                
                if(!posts.length) { tb.innerHTML = '<tr><td colspan="5">Empty</td></tr>'; return; }

                const uids = [...new Set(posts.map(p => p.user_id))];
                const { data: profs } = await this.sb.from('profiles').select('id, username').in('id', uids);
                const map = {}; profs.forEach(p => map[p.id] = p.username);

                tb.innerHTML = '';
                posts.forEach(p => {
                    const prev = p.image_url 
                        ? `<img src="${p.image_url}" class="content-preview-img" onclick="window.open(this.src)">` 
                        : `<div class="content-text-short">${p.content}</div>`;
                    
                    tb.innerHTML += `<tr>
                        <td style="font-family:monospace; font-size:0.7rem">${p.id.slice(0,8)}</td>
                        <td>${map[p.user_id] || 'Unknown'}</td>
                        <td>${prev}</td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                        <td><button class="action-btn btn-ban" onclick="app.deletePost('${p.id}')">DEL</button></td>
                    </tr>`;
                });
            }
            async deletePost(pid) {
                if(!confirm('Удалить пост?')) return;
                await this.sb.from('posts').delete().eq('id', pid);
                await this.log('delete_post', pid, 'Content Moderation');
                this.toast('Пост удален', 'ok');
                this.loadContent();
            }

            // === DATABASE VIEWER (FIXED) ===
            async loadDatabase(table) {
                const thead = document.getElementById('db-thead');
                const tbody = document.getElementById('db-tbody');
                tbody.innerHTML = '<tr><td>Loading...</td></tr>'; thead.innerHTML = '';

                const { data, error } = await this.sb.from(table).select('*').limit(20).order('created_at', {ascending: false});
                
                if(error) { tbody.innerHTML = `<tr><td style="color:red">${error.message}</td></tr>`; return; }
                if(!data.length) { tbody.innerHTML = '<tr><td>Table is empty</td></tr>'; return; }

                // Generate Headers
                const keys = Object.keys(data[0]);
                let headHtml = '<tr>';
                keys.forEach(k => headHtml += `<th>${k}</th>`);
                thead.innerHTML = headHtml + '</tr>';

                // Generate Rows
                tbody.innerHTML = '';
                data.forEach(row => {
                    let rowHtml = '<tr>';
                    keys.forEach(k => {
                        let val = row[k];
                        if(typeof val === 'object') val = JSON.stringify(val);
                        if(String(val).length > 20) val = `<span title="${val}">${String(val).slice(0,20)}...</span>`;
                        rowHtml += `<td>${val}</td>`;
                    });
                    tbody.innerHTML += rowHtml + '</tr>';
                });
            }

            // === REPORTS & LOGS ===
            async loadReports() {
                const tb = document.getElementById('reports-tbody');
                const { data } = await this.sb.from('reports').select('*').eq('status', 'open');
                tb.innerHTML = '';
                if(!data?.length) tb.innerHTML = '<tr><td colspan="5" style="text-align:center">Нет жалоб</td></tr>';
                data?.forEach(r => {
                    tb.innerHTML += `<tr>
                        <td>${r.sender_id.slice(0,6)}</td><td>${r.type}</td><td>${r.target_id.slice(0,6)}</td><td>${r.reason}</td>
                        <td><button class="action-btn btn-view" onclick="app.resRep('${r.id}','resolved')">OK</button><button class="action-btn btn-ban" onclick="app.resRep('${r.id}','dismissed')">X</button></td>
                    </tr>`;
                });
            }
            async resRep(id, st) { await this.sb.from('reports').update({status:st}).eq('id',id); this.loadReports(); }

            async loadLogs() {
                const c = document.getElementById('logs-container');
                const { data } = await this.sb.from('admin_logs').select('*').order('created_at', {ascending:false}).limit(20);
                c.innerHTML = '';
                data?.forEach(l => {
                    c.innerHTML += `<div class="log-entry"><span class="log-time">[${new Date(l.created_at).toLocaleTimeString()}]</span><span class="log-action">${l.action}</span> ${l.details}</div>`;
                });
            }
            async log(act, trg, det) { await this.sb.from('admin_logs').insert([{admin_id:this.me.id, action:act, target_id:trg, details:det}]); }

            // === UTILS ===
            nav(p) {
                document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
                document.getElementById(`view-${p}`).classList.add('active');
                document.getElementById('page-title').innerText = p.toUpperCase();
                document.getElementById('mobile-overlay').classList.remove('open');
                document.getElementById('sidebar').classList.remove('open');
                
                if(p === 'database') this.loadDatabase('profiles');
                if(p === 'content') this.loadContent();
                if(p === 'logs') this.loadLogs();
                if(p === 'reports') this.loadReports();
            }
            toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('open');
                document.getElementById('mobile-overlay').classList.toggle('open');
            }
            closeModal() { document.querySelector('.modal-overlay').classList.remove('open'); }
            toast(m,t) {
                const b = document.getElementById('toasts');
                const d = document.createElement('div'); d.className = `toast`; d.style.borderColor = t==='err'?'#f33':'#0f8';
                d.innerHTML = `<span>${m}</span>`; b.appendChild(d); setTimeout(()=>d.remove(),3000);
            }
        }

        const app = new AdminPanel();
    </script>
</body>
</html>
