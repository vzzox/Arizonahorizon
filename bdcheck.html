<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Debug Memasik</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #111; color: #fff; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        input { width: 100%; padding: 10px; margin: 5px 0; display: block; }
        button { padding: 15px; width: 100%; background: orange; font-weight: bold; cursor: pointer; border: none; }
        #log { margin-top: 20px; white-space: pre-wrap; color: yellow; border: 1px solid #555; padding: 10px; width: 100%; min-height: 50px;}
    </style>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

    <h2>СУПЕР ТЕСТ</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Пароль">
    <button onclick="startTest()">НАЖМИ МЕНЯ</button>

    <div id="log">Статус: Готов к тесту. Нажми кнопку.</div>

    <script>
        // Функция логирования
        function log(text) {
            const el = document.getElementById('log');
            el.innerText += "\n" + text;
            console.log(text);
        }

        // Данные
        const SUPABASE_URL = 'https://hrrzpftxpafnavlljhum.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhycnpwZnR4cGFmbmF2bGxqaHVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzc1NzYsImV4cCI6MjA4NDg1MzU3Nn0.whczAQ9mUOJqT_hMEujiQnFnEuVi27iEPf8VWvCceFE';
        
        let supabase = null;

        function startTest() {
            // 1. Проверяем, жива ли кнопка
            log(">>> Кнопка нажата.");

            // 2. Проверяем, загрузилась ли библиотека
            if (typeof window.supabase === 'undefined') {
                log("!!! ОШИБКА: Библиотека Supabase НЕ загрузилась. Проверь интернет или VPN.");
                return;
            }

            // 3. Пробуем инициализировать клиент
            try {
                if (!supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    log("Клиент Supabase создан.");
                }
                
                // Запускаем регистрацию
                doRegister();

            } catch (e) {
                log("!!! Ошибка при создании клиента: " + e.message);
            }
        }

        async function doRegister() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                log("Поля пустые! Введите данные.");
                return;
            }

            log("Отправка запроса...");

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    log("ОШИБКА ОТ СЕРВЕРА: " + error.message);
                } else {
                    log("УСПЕХ! User ID: " + (data.user ? data.user.id : 'нет ID'));
                    
                    // Пробуем писать профиль
                    if(data.user) {
                        log("Пишем профиль...");
                        const { error: profileError } = await supabase.from('profiles').insert([{
                            id: data.user.id,
                            username: "User_" + Math.floor(Math.random() * 1000), // Рандомный ник
                            created_at: new Date().toISOString()
                        }]);
                        
                        if(profileError) log("Ошибка профиля: " + profileError.message);
                        else log("ПРОФИЛЬ СОЗДАН! ВСЕ РАБОТАЕТ.");
                    }
                }

            } catch (err) {
                log("Критическая ошибка JS: " + err.message);
            }
        }
    </script>
</body>
</html>
