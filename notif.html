<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MEMASIK 2.0 | INBOX</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Unbounded:wght@500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           1. CORE SYSTEM & VARIABLES
           ========================================= */
        :root {
            --bg-root: #0a0a0c;
            --bg-surface: #141416;
            --bg-chat: #000000;
            --bg-nav: rgba(18, 18, 20, 0.96);
            --bg-input: #1f1f22;
            
            --bubble-me: #ff5e00;
            --bubble-they: #222;
            
            --txt-primary: #ffffff;
            --txt-secondary: #9999a1;
            --txt-tertiary: #555;
            
            --accent: #ff5e00;
            --accent-glow: rgba(255, 94, 0, 0.35);
            --danger: #ff3333;
            --success: #00ff88;
            
            --border: #2a2a2e;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;
            
            --header-h: 110px;
            --nav-h: 75px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-root);
            color: var(--txt-primary);
            font-family: 'Manrope', sans-serif;
            height: 100vh;
            overflow: hidden; /* App-like layout */
        }

        /* Cinematic Grain */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
            opacity: 0.6; pointer-events: none; z-index: -1;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* =========================================
           2. HEADER & TABS
           ========================================= */
        .app-header {
            position: absolute; top: 0; left: 0; width: 100%; height: var(--header-h);
            background: rgba(10, 10, 12, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: 5px;
        }

        .header-title {
            text-align: center; font-family: 'Unbounded'; font-weight: 800;
            font-size: 1.1rem; letter-spacing: 2px; color: #fff; margin-bottom: 15px;
            text-transform: uppercase;
        }

        .tabs-row { display: flex; justify-content: center; gap: 40px; position: relative; }
        .tab-btn {
            background: transparent; border: none; color: var(--txt-secondary);
            font-family: 'Unbounded'; font-weight: 700; font-size: 0.8rem;
            cursor: pointer; transition: 0.3s; padding: 10px 5px; position: relative;
        }
        .tab-btn.active { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%;
            transform: translateX(-50%); width: 24px; height: 3px;
            background: var(--accent); border-radius: 2px;
            box-shadow: 0 -2px 10px var(--accent);
        }

        .badge-dot {
            position: absolute; top: 5px; right: -6px;
            width: 8px; height: 8px; background: var(--danger);
            border-radius: 50%; box-shadow: 0 0 5px var(--danger);
            display: none;
        }
        .badge-dot.show { display: block; }

        /* =========================================
           3. MAIN SCROLL AREA
           ========================================= */
        .viewport {
            position: absolute; top: var(--header-h); bottom: var(--nav-h);
            width: 100%; overflow-y: auto; overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .section { display: none; padding-bottom: 20px; animation: fadeIn 0.3s; }
        .section.active { display: block; }

        /* --- NOTIFICATIONS --- */
        .notif-item {
            display: flex; gap: 14px; padding: 16px; align-items: flex-start;
            border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer;
            transition: background 0.2s; position: relative;
        }
        .notif-item:active { background: rgba(255,255,255,0.05); }
        .notif-item.unread::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
            background: var(--accent);
        }

        .n-ava-box { position: relative; flex-shrink: 0; }
        .n-ava {
            width: 46px; height: 46px; border-radius: 50%;
            background: #222; border: 1px solid var(--border);
            display: flex; justify-content: center; align-items: center;
            font-family: 'Unbounded'; font-weight: 700; color: #fff; object-fit: cover;
        }
        .n-icon {
            position: absolute; bottom: -2px; right: -2px;
            width: 20px; height: 20px; border-radius: 50%;
            background: #333; border: 2px solid var(--bg-root);
            display: flex; justify-content: center; align-items: center;
            font-size: 0.7rem; color: #fff;
        }
        .n-icon.like { background: var(--danger); }
        .n-icon.comment { background: #3399ff; }
        .n-icon.follow { background: var(--success); }

        .n-body { flex: 1; min-width: 0; }
        .n-title { font-size: 0.9rem; margin-bottom: 4px; color: #ddd; }
        .n-title b { color: #fff; font-weight: 700; }
        .n-meta { font-size: 0.75rem; color: var(--txt-tertiary); }
        .n-post-preview {
            width: 46px; height: 46px; border-radius: 8px;
            object-fit: cover; border: 1px solid var(--border);
            margin-left: 10px; flex-shrink: 0;
        }

        /* --- MESSAGES LIST --- */
        .msg-tools {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .msg-title { font-family: 'Unbounded'; font-size: 0.8rem; color: var(--txt-secondary); }
        .new-chat-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255,255,255,0.1); color: #fff;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; cursor: pointer; transition: 0.2s;
        }
        .new-chat-btn:active { background: var(--accent); color: #000; }

        .chat-item {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer;
        }
        .chat-item:active { background: rgba(255,255,255,0.05); }
        
        .c-ava-wrap { position: relative; }
        .c-ava {
            width: 54px; height: 54px; border-radius: 50%;
            background: #222; border: 2px solid #222;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Unbounded'; font-weight: 700; color: #fff;
            font-size: 1.2rem; object-fit: cover;
        }
        .c-online {
            position: absolute; bottom: 2px; right: 2px;
            width: 14px; height: 14px; background: var(--success);
            border: 3px solid var(--bg-root); border-radius: 50%;
        }

        .c-info { flex: 1; min-width: 0; }
        .c-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .c-name { font-weight: 700; font-size: 1rem; color: #fff; }
        .c-time { font-size: 0.75rem; color: var(--txt-tertiary); }
        .c-last {
            font-size: 0.9rem; color: var(--txt-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .c-last.new { color: #fff; font-weight: 600; }
        .c-last.typing { color: var(--accent); font-style: italic; font-size: 0.8rem; }

        /* =========================================
           4. CHAT ROOM (FULLSCREEN)
           ========================================= */
        .chat-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-root); z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .chat-screen.open { transform: translateX(0); }

        .cs-header {
            height: 60px; display: flex; align-items: center; gap: 15px;
            padding: 0 15px; background: rgba(20,20,22,0.95);
            border-bottom: 1px solid var(--border); backdrop-filter: blur(10px);
        }
        .cs-back { font-size: 1.6rem; color: #fff; cursor: pointer; padding: 5px; }
        .cs-user { flex: 1; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .cs-ava { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; background: #333; }
        .cs-name { font-family: 'Unbounded'; font-size: 0.9rem; font-weight: 700; color: #fff; }
        .cs-status { font-size: 0.7rem; color: var(--success); }

        .cs-body {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
            background-color: var(--bg-chat);
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .bubble {
            max-width: 75%; padding: 10px 14px; border-radius: 18px;
            font-size: 0.95rem; line-height: 1.4; position: relative;
            word-break: break-word; animation: fadeIn 0.2s;
        }
        .bubble-me {
            align-self: flex-end; background: var(--bubble-me); color: #000;
            border-bottom-right-radius: 4px;
        }
        .bubble-they {
            align-self: flex-start; background: var(--bubble-they); color: #fff;
            border: 1px solid var(--border); border-bottom-left-radius: 4px;
        }
        .bubble-img { max-width: 100%; border-radius: 10px; margin-bottom: 5px; display: block; }
        .bubble-meta { 
            font-size: 0.65rem; text-align: right; margin-top: 4px; opacity: 0.7; 
            display: flex; align-items: center; justify-content: flex-end; gap: 4px;
        }

        .cs-footer {
            padding: 10px 15px; background: var(--bg-surface);
            border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .cs-btn { font-size: 1.5rem; color: var(--txt-secondary); cursor: pointer; transition: 0.2s; }
        .cs-btn:active { color: var(--accent); }
        
        .cs-input {
            flex: 1; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 20px; padding: 10px 16px; color: #fff;
            font-family: 'Manrope'; font-size: 1rem; transition: 0.3s;
        }
        .cs-input:focus { border-color: var(--accent); }
        
        .cs-send {
            width: 42px; height: 42px; background: var(--accent);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #000; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .cs-send:active { transform: scale(0.9); }

        /* =========================================
           5. USER SEARCH MODAL (START CHAT)
           ========================================= */
        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal-wrap.open { display: flex; animation: fadeIn 0.2s; }
        
        .modal-box {
            width: 90%; max-width: 400px; background: var(--bg-surface);
            border-radius: var(--radius-xl); border: 1px solid var(--border);
            overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-wrap.open .modal-box { transform: scale(1); }

        .m-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .m-title { font-family: 'Unbounded'; font-size: 1rem; color: #fff; }
        .m-close { font-size: 1.5rem; color: var(--txt-tertiary); cursor: pointer; }
        
        .m-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .m-search {
            width: 100%; background: var(--bg-input); padding: 12px;
            border-radius: 12px; border: 1px solid var(--border);
            color: #fff; margin-bottom: 15px;
        }
        
        .user-row {
            display: flex; align-items: center; gap: 12px; padding: 10px;
            border-radius: 12px; cursor: pointer; transition: 0.2s;
        }
        .user-row:hover { background: rgba(255,255,255,0.05); }
        .u-ava { width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; border: 1px solid #333; }
        .u-name { font-weight: 700; font-size: 0.9rem; color: #fff; }
        .u-nick { font-size: 0.75rem; color: var(--txt-secondary); }

        /* =========================================
           6. NAV BAR
           ========================================= */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h);
            background: var(--bg-nav); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 99; backdrop-filter: blur(12px);
            padding-bottom: 10px;
        }
        .nav-icon { font-size: 1.6rem; color: var(--txt-secondary); cursor: pointer; transition: 0.2s; }
        .nav-icon.active { color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.3); transform: translateY(-2px); }
        .nav-fab {
            width: 54px; height: 54px; background: var(--accent);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #000; font-size: 1.8rem; transform: translateY(-25%);
            border: 4px solid var(--bg-root); box-shadow: 0 5px 25px var(--accent-glow);
            cursor: pointer;
        }

        /* Utils */
        .spinner { display: block; margin: 30px auto; font-size: 2rem; color: var(--txt-tertiary); animation: spin 1s linear infinite; }
        .empty-st { text-align: center; margin-top: 50px; color: var(--txt-tertiary); }
        .hidden-file { display: none; }

    </style>
</head>
<body>

    <audio id="snd-in" src="https://cdn.freesound.org/previews/234/234526_4019029-lq.mp3"></audio>
    <audio id="snd-out" src="https://cdn.freesound.org/previews/556/556770_9549302-lq.mp3"></audio>

    <div class="app-header">
        <div class="header-title">–í–•–û–î–Ø–©–ò–ï</div>
        <div class="tabs-row">
            <button class="tab-btn active" id="tab-act" onclick="app.switchTab('activity')">
                –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å <span class="badge-dot" id="dot-act"></span>
            </button>
            <button class="tab-btn" id="tab-msg" onclick="app.switchTab('messages')">
                –°–æ–æ–±—â–µ–Ω–∏—è <span class="badge-dot" id="dot-msg"></span>
            </button>
        </div>
    </div>

    <div class="viewport">
        
        <div class="section active" id="sec-activity">
            <div id="list-notifs">
                <i class="ri-loader-4-line spinner"></i>
            </div>
        </div>

        <div class="section" id="sec-messages">
            <div class="msg-tools">
                <span class="msg-title">–í–ê–®–ò –ß–ê–¢–´</span>
                <div class="new-chat-btn" onclick="app.openUserSearch()"><i class="ri-add-line"></i></div>
            </div>
            <div id="list-chats">
                </div>
        </div>

    </div>

    <div class="chat-screen" id="chat-ui">
        <div class="cs-header">
            <i class="ri-arrow-left-s-line cs-back" onclick="app.closeChat()"></i>
            <div class="cs-user">
                <img src="" class="cs-ava" id="chat-ava-img">
                <div>
                    <div class="cs-name" id="chat-username">User</div>
                    <div class="cs-status">–≤ —Å–µ—Ç–∏</div>
                </div>
            </div>
            <i class="ri-more-2-fill cs-back"></i>
        </div>

        <div class="cs-body" id="chat-log"></div>

        <div class="cs-footer">
            <label class="cs-btn">
                <i class="ri-image-add-line"></i>
                <input type="file" id="chat-file" class="hidden-file" accept="image/*" onchange="app.handleChatFile()">
            </label>
            <input type="text" id="chat-inp" class="cs-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <div class="cs-send" onclick="app.sendMessage()"><i class="ri-send-plane-2-fill"></i></div>
        </div>
    </div>

    <div class="modal-wrap" id="user-modal">
        <div class="modal-box">
            <div class="m-head">
                <div class="m-title">–ù–∞—á–∞—Ç—å —á–∞—Ç</div>
                <i class="ri-close-line m-close" onclick="app.closeUserSearch()"></i>
            </div>
            <div class="m-body">
                <input type="text" class="m-search" id="user-search-inp" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." oninput="app.searchUsers(this.value)">
                <div id="user-results"></div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-icon" onclick="window.location.href='feed.html'"><i class="ri-home-5-line"></i></div>
        <div class="nav-icon" onclick="window.location.href='search.html'"><i class="ri-search-2-line"></i></div>
        <div class="nav-fab" onclick="window.location.href='feed.html'"><i class="ri-add-line"></i></div>
        <div class="nav-icon active"><i class="ri-heart-3-fill"></i></div>
        <div class="nav-icon" onclick="window.location.href='profile.html'"><i class="ri-user-3-line"></i></div>
    </nav>

    <div id="toast-container"></div>

    <script>
        /**
         * MEMASIK 2.0 - TITAN COMMUNICATION CORE (V8.0)
         * Realtime Notifications, Instant Chat, SQL-backed Triggers.
         */

        const CONFIG = {
            URL: 'https://hrrzpftxpafnavlljhum.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhycnpwZnR4cGFmbmF2bGxqaHVtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTI3NzU3NiwiZXhwIjoyMDg0ODUzNTc2fQ.5Dt7zXjEF_lVc5Komkg11A4Jy97rxI94PF3UE40X1RE',
            BUCKET: 'memasik_files'
        };

        class TitanApp {
            constructor() {
                this.sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
                this.me = null;
                this.chatPartner = null;
                this.realtime = null;
                
                this.init();
            }

            async init() {
                // 1. Auth
                const { data: { user } } = await this.sb.auth.getUser();
                if (!user) return window.location.href = 'index.html';
                this.me = user;

                // 2. Load Data
                this.loadNotifications();
                this.loadChats();
                
                // 3. Check for Deeplink (URL params)
                const params = new URLSearchParams(window.location.search);
                const chatUserId = params.get('chat');
                if(chatUserId) this.startChat(chatUserId);

                // 4. Realtime Subscription
                this.subscribe();
            }

            // === 1. NOTIFICATIONS ===
            async loadNotifications() {
                const list = document.getElementById('list-notifs');
                
                const { data: notifs } = await this.sb
                    .from('notifications')
                    .select('*')
                    .eq('user_id', this.me.id)
                    .order('created_at', { ascending: false })
                    .limit(30);

                if (!notifs || notifs.length === 0) {
                    list.innerHTML = '<div class="empty-st">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                    return;
                }

                // Get Actor Profiles
                const uids = [...new Set(notifs.map(n => n.actor_id))];
                const { data: profs } = await this.sb.from('profiles').select('*').in('id', uids);
                const map = {}; profs?.forEach(p => map[p.id] = p);

                list.innerHTML = '';
                notifs.forEach(n => {
                    const actor = map[n.actor_id] || { username: 'User' };
                    const ava = actor.avatar_url ? `<img src="${actor.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : actor.username[0].toUpperCase();
                    
                    let text = "–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Å –≤–∞–º–∏";
                    let icon = "";
                    if (n.type === 'like') { text = "–æ—Ü–µ–Ω–∏–ª –≤–∞—à—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é"; icon = "ri-heart-3-fill n-icon like"; }
                    if (n.type === 'comment') { text = `–Ω–∞–ø–∏—Å–∞–ª: "${n.content}"`; icon = "ri-chat-1-fill n-icon comment"; }
                    if (n.type === 'follow') { text = "–ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"; icon = "ri-user-follow-fill n-icon follow"; }

                    const html = `
                    <div class="notif-item ${n.is_read ? '' : 'unread'}">
                        <div class="n-ava-box">
                            <div class="n-ava">${ava}</div>
                            <i class="${icon}"></i>
                        </div>
                        <div class="n-body">
                            <div class="n-title"><b>${actor.username}</b> ${text}</div>
                            <div class="n-meta">${this.timeAgo(n.created_at)}</div>
                        </div>
                    </div>`;
                    list.insertAdjacentHTML('beforeend', html);
                });
            }

            // === 2. CHATS LIST ===
            async loadChats() {
                const list = document.getElementById('list-chats');
                
                // Get all messages where I am sender OR receiver
                const { data: msgs } = await this.sb
                    .from('messages')
                    .select('*')
                    .or(`sender_id.eq.${this.me.id},receiver_id.eq.${this.me.id}`)
                    .order('created_at', { ascending: false });

                if (!msgs || msgs.length === 0) {
                    list.innerHTML = '<div class="empty-st">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –Ω–∞–∂–∞–≤ +</div>';
                    return;
                }

                const partners = new Map();
                msgs.forEach(m => {
                    const pid = m.sender_id === this.me.id ? m.receiver_id : m.sender_id;
                    if (!partners.has(pid)) partners.set(pid, m);
                });

                const pids = Array.from(partners.keys());
                const { data: profs } = await this.sb.from('profiles').select('*').in('id', pids);
                const map = {}; profs?.forEach(p => map[p.id] = p);

                list.innerHTML = '';
                partners.forEach((lastMsg, pid) => {
                    const p = map[pid] || { username: 'Deleted', id: pid };
                    const ava = p.avatar_url ? `<img src="${p.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : p.username[0].toUpperCase();
                    
                    const isMe = lastMsg.sender_id === this.me.id;
                    const txt = lastMsg.image_url ? 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è' : lastMsg.content;
                    const preview = isMe ? `–í—ã: ${txt}` : txt;
                    const unread = !isMe && !lastMsg.is_read ? 'new' : '';

                    const html = `
                    <div class="chat-item" onclick="app.startChat('${p.id}')">
                        <div class="c-ava-wrap">
                            <div class="c-ava">${ava}</div>
                            <div class="c-online"></div>
                        </div>
                        <div class="c-info">
                            <div class="c-top">
                                <span class="c-name">${p.display_name || p.username}</span>
                                <span class="c-time">${this.timeAgo(lastMsg.created_at, true)}</span>
                            </div>
                            <div class="c-last ${unread}">${preview}</div>
                        </div>
                    </div>`;
                    list.insertAdjacentHTML('beforeend', html);
                });
            }

            // === 3. CHAT ROOM ===
            async startChat(userId) {
                this.chatPartner = userId;
                document.getElementById('chat-ui').classList.add('open');
                
                // Get User Info
                const { data: user } = await this.sb.from('profiles').select('*').eq('id', userId).single();
                if(user) {
                    document.getElementById('chat-username').innerText = user.username;
                    const img = document.getElementById('chat-ava-img');
                    img.src = user.avatar_url || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9iMTAwIiBmaWxsPSIjMzMzIi8+PC9zdmc+';
                }

                this.loadMessages(userId);
            }

            async loadMessages(pid) {
                const log = document.getElementById('chat-log');
                log.innerHTML = '<div style="text-align:center;margin-top:20px;color:#555">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';

                const { data: msgs } = await this.sb
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${this.me.id},receiver_id.eq.${pid}),and(sender_id.eq.${pid},receiver_id.eq.${this.me.id})`)
                    .order('created_at', { ascending: true });

                log.innerHTML = '';
                if(msgs) msgs.forEach(m => this.renderBubble(m));
                this.scrollChat();
            }

            renderBubble(m) {
                const log = document.getElementById('chat-log');
                const isMe = m.sender_id === this.me.id;
                const type = isMe ? 'bubble-me' : 'bubble-they';
                
                let content = m.content;
                if(m.image_url) content = `<img src="${m.image_url}" class="bubble-img" onclick="window.open(this.src)">` + (content || '');

                const html = `
                <div class="bubble ${type}">
                    ${content}
                    <div class="bubble-meta">
                        ${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                        ${isMe ? '<i class="ri-check-double-line"></i>' : ''}
                    </div>
                </div>`;
                log.insertAdjacentHTML('beforeend', html);
            }

            async sendMessage() {
                const inp = document.getElementById('chat-inp');
                const fileInp = document.getElementById('chat-file');
                const text = inp.value.trim();
                const file = fileInp.files[0];

                if((!text && !file) || !this.chatPartner) return;

                // Optimistic UI
                this.renderBubble({
                    sender_id: this.me.id, content: text || '...', created_at: new Date(), image_url: file ? URL.createObjectURL(file) : null
                });
                this.scrollChat();
                this.play('out');
                inp.value = '';

                try {
                    let url = null;
                    if(file) {
                        const path = `chat/${Date.now()}_${file.name}`;
                        await this.sb.storage.from(CONFIG.BUCKET).upload(path, file);
                        url = this.sb.storage.from(CONFIG.BUCKET).getPublicUrl(path).data.publicUrl;
                    }

                    await this.sb.from('messages').insert([{
                        sender_id: this.me.id,
                        receiver_id: this.chatPartner,
                        content: text,
                        image_url: url
                    }]);
                    fileInp.value = '';
                } catch(e) { console.error(e); }
            }

            // === 4. USER SEARCH ===
            openUserSearch() { document.getElementById('user-modal').classList.add('open'); document.getElementById('user-search-inp').focus(); }
            closeUserSearch() { document.getElementById('user-modal').classList.remove('open'); }

            async searchUsers(query) {
                const resBox = document.getElementById('user-results');
                if(query.length < 2) { resBox.innerHTML = ''; return; }

                const { data } = await this.sb.from('profiles')
                    .select('*')
                    .ilike('username', `%${query}%`)
                    .limit(5);

                resBox.innerHTML = '';
                data?.forEach(u => {
                    if(u.id === this.me.id) return;
                    const html = `
                    <div class="user-row" onclick="app.startChat('${u.id}'); app.closeUserSearch()">
                        <div class="u-ava">${(u.username||'U')[0].toUpperCase()}</div>
                        <div>
                            <div class="u-name">${u.username}</div>
                            <div class="u-nick">–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                        </div>
                    </div>`;
                    resBox.insertAdjacentHTML('beforeend', html);
                });
            }

            // === 5. REALTIME ===
            subscribe() {
                this.sb.channel('global')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                    const m = payload.new;
                    if((m.sender_id === this.chatPartner || m.sender_id === this.me.id) && document.getElementById('chat-ui').classList.contains('open')) {
                        if(m.sender_id !== this.me.id) {
                            this.renderBubble(m);
                            this.scrollChat();
                            this.play('in');
                        }
                    } else if (m.receiver_id === this.me.id) {
                        this.toast(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${m.sender_id.slice(0,5)}...`);
                        document.getElementById('dot-msg').classList.add('show');
                        this.loadChats();
                    }
                })
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
                    if(payload.new.user_id === this.me.id) {
                        this.loadNotifications();
                        document.getElementById('dot-act').classList.add('show');
                    }
                })
                .subscribe();
            }

            // === UTILS ===
            switchTab(t) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(`tab-${t === 'activity' ? 'act' : 'msg'}`).classList.add('active');
                document.getElementById(`sec-${t === 'activity' ? 'activity' : 'messages'}`).classList.add('active');
                if(t==='activity') document.getElementById('dot-act').classList.remove('show');
                if(t==='messages') document.getElementById('dot-msg').classList.remove('show');
            }

            closeChat() { document.getElementById('chat-ui').classList.remove('open'); this.chatPartner = null; this.loadChats(); }
            handleChatFile() { this.sendMessage(); }
            scrollChat() { const l = document.getElementById('chat-log'); l.scrollTop = l.scrollHeight; }
            play(t) { document.getElementById(t==='in'?'snd-in':'snd-out').play().catch(()=>{}); if(navigator.vibrate) navigator.vibrate(10); }
            
            toast(m) {
                const b = document.getElementById('toast-container');
                const d = document.createElement('div'); d.className = 'toast'; d.innerText = m;
                b.appendChild(d); setTimeout(()=>d.remove(), 3000);
            }

            timeAgo(d, short=false) {
                const s = Math.floor((new Date()-new Date(d))/1000);
                if(s<60) return short ? '1–º' : '–¢–æ–ª—å–∫–æ —á—Ç–æ';
                if(s<3600) return Math.floor(s/60) + (short?'–º':' –º–∏–Ω');
                if(s<86400) return Math.floor(s/3600) + (short?'—á':' —á');
                return new Date(d).toLocaleDateString();
            }
        }

        const app = new TitanApp();
    </script>
</body>
</html>
